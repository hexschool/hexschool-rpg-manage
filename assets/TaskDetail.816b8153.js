import{d as O,N as pe,l as ve,u as be,r as g,s as ge,o as he,z as F,a as r,c as d,b as e,A as _,f as N,h as k,x as E,g as W,D as j,F as C,q as $,a3 as fe,a4 as ke,i as se,L as ye,w as v,v as I,p as G,C as R,Q as we}from"./index.b171e68b.js";import{I as xe,_ as Ve}from"./Editor.be61f9bc.js";/* empty css                   */import{a as Ue}from"./task.face143e.js";import{a as Te}from"./task-tags.e1e95587.js";const ae=f=>({"image/png":"png","image/jpg":"jpeg","image/jpeg":"jpeg"})[f],Ce=f=>new Promise((m,y)=>{const h=new FileReader;h.readAsArrayBuffer(f),h.onload=L=>{const{result:S}=L.target;m(S)},h.onerror=y}),$e={name:"ImageUploader",module:xe,options:{upload(f){return new Promise((m,y)=>{const{type:h,size:L}=f;if(!ae(h)){postMessage("danger","\u5716\u7247\u683C\u5F0F\u932F\u8AA4","\u50C5\u9650\u4E0A\u50B3 png\u3001jpg \u8207 jpeg \u6A94\u6848\u683C\u5F0F"),y(new Error("\u50C5\u9650\u4E0A\u50B3 png\u3001jpg \u8207 jpeg \u6A94\u6848\u683C\u5F0F"));return}const S=1024*1024*3;if(L>=S){postMessage("danger","\u5716\u7247\u904E\u5927","\u5716\u7247\u5927\u5C0F\u4E0D\u5F97\u8D85\u904E 3MB\u3002"),y(new Error("\u5716\u7247\u5927\u5C0F\u4E0D\u5F97\u8D85\u904E 3MB\u3002"));return}const P=`/v1/common/upload/image/${ae(h)}`;(async()=>{try{const w=await Ce(f),{data:x}=await O.get(P),z=x.image_url,q=x.upload_url,V={transformRequest(a,M){return delete M.common.Authorization,a},headers:{"Content-Type":h},withCredentials:!1};await O.put(q,w,V),m(z)}catch{postMessage("danger","\u5716\u7247\u4E0A\u50B3\u5931\u6557","\u5716\u7247\u4E0A\u50B3\u5931\u6557\uFF0C\u8ACB\u91CD\u65B0\u4E0A\u50B3\u3002"),y(new Error("\u5716\u7247\u4E0A\u50B3\u5931\u6557\u3002"))}})()})}}};const Ie={class:"about task-detail px-4 mt-4"},Le={class:"border-bottom border-light pb-2 mb-4"},Se={"aria-label":"breadcrumb"},Me={class:"breadcrumb"},Be={class:"breadcrumb-item"},Fe={class:"breadcrumb-item active","aria-current":"page"},je={class:"fs-4 mb-3"},qe={class:"my-3"},Ae={class:"row"},Ne={class:"col-md-6"},Ee={class:"mb-3"},Ge=e("label",{class:"form-label",for:"name"},"\u4EFB\u52D9\u540D\u7A31",-1),Re={class:"col-md-6"},Oe={class:"mb-3"},Pe=e("label",{class:"form-label",for:"taskGroupName"},"\u6240\u5C6C\u7FA4\u7D44",-1),ze={class:"position-relative"},De=["value"],Je=["required"],He={class:"col-md-6"},Qe={class:"mb-3"},Ke=e("label",{class:"form-label",for:"image_url"},"\u4EFB\u52D9\u5716\u7247 (1200 x 628)",-1),We={class:"position-relative"},Xe={class:"mt-2"},Ye=["src"],Ze={key:1,class:"preview-block"},et={class:"col-md-6"},tt={class:"mb-3"},st=e("label",{class:"form-label",for:"taskPoint"},"\u4EFB\u52D9\u7A4D\u5206",-1),at={class:"mb-3"},ot=e("label",{class:"form-label",for:"abstract"},"\u6458\u8981",-1),lt={class:"mb-3"},nt=e("label",{class:"form-label",for:"description"},"\u4EFB\u52D9\u5167\u5BB9\u8AAA\u660E",-1),it={class:"mt-3 position-relative"},rt={class:"card shadow-sm rounded-4 overflow-hidden mb-4"},dt={class:"card-header bg-white py-3"},ct={key:0},ut={class:"card-body card-body-height"},_t={class:"list list-unstyled"},mt={class:"form-check"},pt=["id","value"],vt=["for"],bt=e("hr",null,null,-1),gt={class:"row"},ht={class:"col-md-6"},ft={class:"card shadow-sm rounded-4 overflow-hidden mb-4"},kt=e("div",{class:"card-header bg-white py-3"},"\u4EFB\u52D9\u5B8C\u6210\u5F8C\u6703\u7372\u5F97\u7684\u6280\u80FD",-1),yt={class:"card-body card-body-height"},wt={class:"mb-3"},xt=e("label",{class:"form-label d-block h5",for:"summary"},null,-1),Vt=["onUpdate:modelValue"],Ut=["onClick"],Tt={class:"col-md-6"},Ct={class:"card shadow-sm rounded-4 overflow-hidden mb-4"},$t=e("div",{class:"card-header bg-white py-3"},"\u4EFB\u52D9\u5B8C\u6210\u689D\u4EF6",-1),It={class:"card-body card-body-height"},Lt={class:"mb-3"},St=["onUpdate:modelValue"],Mt=["onClick"],Bt=e("hr",null,null,-1),Ft=e("h5",null,"\u662F\u5426\u5305\u542B\u7B49\u7D1A",-1),jt={class:"form-check mb-3"},qt=e("label",{class:"form-check-label",for:"task-has-level"}," \u986F\u793A\u4EFB\u52D9\u5206\u968E\u7B49\u7D1A ",-1),At={key:0,class:"my-3"},Nt=["onUpdate:modelValue"],Et=["onClick"],Gt=e("hr",null,null,-1),Rt=e("h5",null,"\u662F\u5426\u9700\u8981\u524D\u7F6E\u4EFB\u52D9",-1),Ot={class:"form-check mb-3"},Pt=e("label",{class:"form-check-label",for:"beforeStart"}," \u662F\u5426\u9700\u8981\u524D\u7F6E\u4EFB\u52D9 ",-1),zt={key:1,class:"mb-3"},Dt=e("label",{class:"form-label",for:"predecessor_task_id"},"\u524D\u7F6E\u4EFB\u52D9",-1),Jt=["value"],Ht=e("hr",null,null,-1),Qt={class:"row"},Kt={class:"col-md-6"},Wt={class:"mb-3"},Xt=e("label",{class:"form-label",for:"task_start_at"},"\u958B\u59CB\u6642\u9593",-1),Yt={class:"col-md-6"},Zt={class:"mb-3"},es=e("label",{class:"form-label",for:"task_expired_at"},"\u5230\u671F\u6642\u9593",-1),ts={class:"form-check mb-3"},ss=e("label",{class:"form-check-label",for:"enable"}," \u662F\u5426\u555F\u7528\u4EFB\u52D9 ",-1),as={class:"d-flex justify-content-end"},os={class:"d-flex flex-column align-items-end"},ls=["disabled"],ns=e("i",{class:"fas fa-save"},null,-1),is={key:0,class:"mb-0 mt-2 text-danger"},ps={__name:"TaskDetail",props:{type:{type:String}},setup(f){const m=f,{apiGetTasks:y,apiGetTaskGroupsList:h,apiGetTaskById:L,apiPostTask:S,apiPutTaskById:P}=Ue,{apiGetTaskTags:X}=Te,w=pe.useLoading(),x=ve(),z=be(),q=g(null),V=g(!1),a=g({name:"",task_group_id:"",image_url:"",tag_ids:[],rewarded_skills:[{content:""}],completion_criteria:[{content:""}],level:[]}),M=l=>{a.value[l].push({content:""})},D=(l,t)=>{a.value[l].splice(t,1)},A=g(""),J=g([]),H=g([]),Q=g({current_page:1,total_page:1,total:0}),oe=async()=>{const l=w.show(),{task_groups:t}=await h({page:1,count:150}),{task_tags:o,pagination:i}=await X({page:1,count:150});J.value=t,H.value=o,Q.value=i,l.hide()},U=g(!1),Y=g([]),le=async l=>{const t=w.show(),{tasks:o}=await y({count:100,page:1,scoped:l});Y.value=o.filter(i=>i.id!==A.value),t.hide()};ge(()=>U.value,l=>{if(l){const t=a.value.task_group_id;if(!t)E("danger","\u8ACB\u5148\u9078\u64C7\u4EFB\u52D9\u7FA4\u7D44","\u56E0\u524D\u7F6E\u4EFB\u52D9\u8981\u548C\u6B64\u4EFB\u52D9\u5728\u540C\u4E00\u500B\u7FA4\u7D44\u4E0B\uFF0C\u8ACB\u5148\u9078\u64C7\u4EFB\u52D9\u7FA4\u7D44");else{const o=`&filter=task_group&task_group_id=${t}`;le(o)}}});const Z=async l=>{var i,n,b,T;const t=w.show(),{task:o}=await L(l);a.value={name:o.name,task_group_id:(i=o==null?void 0:o.task_group)==null?void 0:i.id,predecessor_task_id:(n=o==null?void 0:o.predecessor_task)==null?void 0:n.id,tag_ids:o.tags.map(c=>c.id),rewarded_point:o.rewarded_point,abstract:o.abstract,description:o.description,rewarded_skills:o.rewarded_skills.map(c=>({content:c})),completion_criteria:o.completion_criteria.map(c=>({content:c})),level:o.level?o.level.map(c=>({content:c})):[],start_at:o.start_at?new Date(o.start_at).toLocaleDateString("sv-SE"):null,expired_at:o.expired_at?new Date(o.expired_at).toLocaleDateString("sv-SE"):null,enable:o.enable,image_url:o.image_url},(o==null?void 0:o.level)&&((b=o.level)==null?void 0:b.length)>0&&(V.value=!0),(o==null?void 0:o.predecessor_task)&&((T=o.predecessor_task)==null?void 0:T.id)&&(U.value=!0),t.hide()};he(async()=>{const{id:l}=x.params,{task_copy_id:t}=x.query;oe(),A.value=l,A.value&&Z(l),t&&!l&&Z(t)});const ne=async()=>{var i;a.value.description=q.value.editorContent,U.value||delete a.value.predecessor_task_id;const l=JSON.parse(JSON.stringify(a.value.completion_criteria.filter(n=>n.content!=="")));a.value.completion_criteria=l.map(n=>n.content);const t=JSON.parse(JSON.stringify(a.value.rewarded_skills.filter(n=>n.content!=="")));a.value.rewarded_skills=t==null?void 0:t.map(n=>n.content),((i=a.value.level)==null?void 0:i.length)===0?delete a.value.level:a.value.level=a.value.level?a.value.level.map(n=>n.content):[];const o=m.type==="create"?"\u65B0\u589E":"\u7DE8\u8F2F";try{Object.keys(a.value).forEach(n=>{a.value[n]===null&&delete a.value[n]}),m.type==="create"&&await S(a.value),m.type==="edit"&&await P(A.value,a.value),E("success",`${o}\u6210\u529F`,`${o}\u4EFB\u52D9\u6210\u529F`),z.push({name:"TaskList",query:x.query})}catch(n){E("danger",`${o}\u5931\u6557`,`${n.response.data.statusCode}:${n.response.data.message}`)}},B=g(!1),ie=l=>new Promise((t,o)=>{const i=new FileReader;i.readAsArrayBuffer(l),i.onload=n=>{const{result:b}=n.target;t(b)},i.onerror=o}),K=(l,t)=>{B.value=!1,l.target.value="",E("danger","\u5716\u7247\u4E0A\u50B3\u5931\u6557",`${t}`)},re=l=>{B.value=!0;const t=l.target.files[0],o=3*1024*1024;if(t.size>o){K(l,"\u5716\u7247\u5927\u5C0F\u4E0D\u80FD\u8D85\u904E 3MB");return}if(t){const i=new FileReader;i.onload=n=>{const b=new Image;b.onload=()=>{const{width:T,height:c}=b;if(T===1200&&c===628){const u=`/v1/common/upload/image/${t.type.split("/")[1]}`;(async()=>{try{const ee=await ie(t),{data:te}=await O.get(u),de=te.image_url,ce=te.upload_url,ue={transformRequest(_e,me){return delete me.common.Authorization,_e},headers:{"Content-Type":t.type},withCredentials:!1};await O.put(ce,ee,ue),a.value.image_url=de,B.value=!1}catch{K(l,"\u5716\u7247\u4E0A\u50B3\u5931\u6557\uFF0C\u8ACB\u91CD\u65B0\u4E0A\u50B3\u3002")}})()}else K(l,"\u5716\u7247\u5BEC\u9AD8\u9700\u7B26\u5408 1200 x 628")},b.src=n.target.result},i.readAsDataURL(t)}};return(l,t)=>{const o=F("router-link"),i=F("Field"),n=F("ErrorMessage"),b=F("v-select"),T=F("VForm");return r(),d("div",Ie,[e("header",Le,[e("nav",Se,[e("ol",Me,[e("li",Be,[_(o,{to:"/admin/task/list"},{default:N(()=>[W(" \u4EFB\u52D9\u5217\u8868 ")]),_:1})]),e("li",Fe,k(m.type==="create"?"\u65B0\u589E\u4EFB\u52D9":"\u7DE8\u8F2F\u4EFB\u52D9"),1)])])]),e("h1",je,k(m.type==="create"?"\u65B0\u589E\u4EFB\u52D9":"\u7DE8\u8F2F\u4EFB\u52D9"),1),e("div",qe,[_(T,{ref:"myForm",onSubmit:ne},{default:N(({errors:c})=>[e("div",Ae,[e("div",Ne,[e("div",Ee,[Ge,_(i,{id:"name",modelValue:a.value.name,"onUpdate:modelValue":t[0]||(t[0]=s=>a.value.name=s),name:"name",label:"\u4EFB\u52D9\u540D\u7A31",type:"text",class:j(["form-control",{"is-invalid":c.name}]),rules:{required:!0}},null,8,["modelValue","class"]),_(n,{name:"name",class:"invalid-feedback"})])]),e("div",Re,[e("div",Oe,[Pe,e("div",ze,[_(i,{as:"select",id:"taskGroupName",modelValue:a.value.task_group_id,"onUpdate:modelValue":t[1]||(t[1]=s=>a.value.task_group_id=s),name:"task_group_id",class:j(["form-select",{"is-invalid":c.task_group_id}]),label:"\u6240\u5C6C\u7FA4\u7D44",rules:{required:!0}},{default:N(()=>[(r(!0),d(C,null,$(J.value,s=>(r(),d("option",{key:s.id,value:s.id},k(s.name),9,De))),128))]),_:2},1032,["modelValue","class"]),_(b,{options:J.value,label:"name",class:"form-select position-absolute",modelValue:a.value.task_group_id,"onUpdate:modelValue":t[2]||(t[2]=s=>a.value.task_group_id=s),clearable:!1,reduce:s=>s.id,style:{border:"0",padding:"0",background:"white",width:"calc(100% - 2px)",left:"1px",top:"1px"}},{search:N(({attributes:s,events:u})=>[e("input",fe({class:"vs__search",required:!a.value.task_group_id},s,ke(u,!0)),null,16,Je)]),_:1},8,["options","modelValue","reduce"])]),_(n,{name:"task_group_id",class:"invalid-feedback"}),e("span",{class:j(["invalid-feedback",{"d-block":c.task_group_id}])},"\u6240\u5C6C\u7FA4\u7D44 \u70BA\u5FC5\u586B",2)])]),e("div",He,[e("div",Qe,[Ke,e("div",We,[_(se(ye),{active:B.value,"is-full-page":!1,width:30,height:30},null,8,["active"]),e("input",{ref:"uploadTaskImageRef",type:"file",class:"form-control mb-2",accept:".png,.jpg,.jpeg",onChange:re},null,544)]),_(i,{id:"image_url",modelValue:a.value.image_url,"onUpdate:modelValue":t[3]||(t[3]=s=>a.value.image_url=s),name:"image_url",label:"\u4EFB\u52D9\u5716\u7247",type:"text",disabled:B.value,class:j(["form-control",{"is-invalid":c.image_url}]),rules:{required:!0}},null,8,["modelValue","disabled","class"]),_(n,{name:"image_url",class:"invalid-feedback"}),e("div",Xe,[a.value.image_url?(r(),d("img",{key:0,src:a.value.image_url,alt:"\u4EFB\u52D9\u5716\u7247",width:"300"},null,8,Ye)):(r(),d("div",Ze))])])]),e("div",et,[e("div",tt,[st,_(i,{id:"taskPoint",modelValue:a.value.rewarded_point,"onUpdate:modelValue":t[4]||(t[4]=s=>a.value.rewarded_point=s),modelModifiers:{number:!0},name:"rewarded_point",label:"\u4EFB\u52D9\u7A4D\u5206",type:"number",class:j(["form-control",{"is-invalid":c.rewarded_point}]),rules:{required:!0,min_value:10}},null,8,["modelValue","class"]),_(n,{name:"rewarded_point",class:"invalid-feedback"})])])]),e("div",at,[ot,v(e("textarea",{class:"form-control",id:"abstract",placeholder:"","onUpdate:modelValue":t[5]||(t[5]=s=>a.value.abstract=s)},null,512),[[I,a.value.abstract]])]),e("div",lt,[nt,_(Ve,{ref_key:"editorRef",ref:q,content:a.value.description,modules:se($e)},null,8,["content","modules"])]),e("div",it,[e("div",rt,[e("div",dt,[W("\u4EFB\u52D9\u6A19\u7C64 "),Q.value.total>0?(r(),d("small",ct," \uFF5C\u5DF2\u8F09\u5165 "+k(H.value.length)+" \u500B / \u5171 "+k(Q.value.total)+" \u500B",1)):G("",!0)]),e("div",ut,[e("ul",_t,[(r(!0),d(C,null,$(H.value,(s,u)=>(r(),d("li",{key:`group-${u}`,class:"list-item"},[e("div",mt,[v(e("input",{"onUpdate:modelValue":t[6]||(t[6]=p=>a.value.tag_ids=p),name:"tag_ids",id:s.id,class:"form-check-input",type:"checkbox",value:s.id},null,8,pt),[[R,a.value.tag_ids]]),e("label",{class:"form-check-label",for:s.id},k(s.name),9,vt)]),bt]))),128))])])])]),e("div",gt,[e("div",ht,[e("div",ft,[kt,e("div",yt,[e("div",wt,[xt,(r(!0),d(C,null,$(a.value.rewarded_skills,(s,u)=>(r(),d("div",{class:"input-group mb-3",key:`skill_${u}`},[v(e("input",{type:"text",class:"form-control","onUpdate:modelValue":p=>s.content=p,placeholder:"\u6280\u80FD\u63CF\u8FF0","aria-label":"\u6280\u80FD\u63CF\u8FF0","aria-describedby":"button-addon2"},null,8,Vt),[[I,s.content]]),e("button",{class:"btn btn-outline-danger",type:"button",id:"button-addon2",onClick:p=>D("rewarded_skills",u)}," \u522A\u9664 ",8,Ut)]))),128)),e("button",{type:"button",class:"btn btn-sm btn-outline-primary",onClick:t[7]||(t[7]=s=>M("rewarded_skills"))}," \u65B0\u589E\u4E00\u5217 ")])])])]),e("div",Tt,[e("div",Ct,[$t,e("div",It,[e("div",Lt,[(r(!0),d(C,null,$(a.value.completion_criteria,(s,u)=>(r(),d("div",{class:"input-group mb-3",key:`complete_${u}`},[v(e("input",{type:"text",class:"form-control",placeholder:"\u5B8C\u6210\u689D\u4EF6","aria-label":"\u5B8C\u6210\u689D\u4EF6","onUpdate:modelValue":p=>s.content=p,"aria-describedby":"button-addon2"},null,8,St),[[I,s.content]]),e("button",{class:"btn btn-outline-danger",type:"button",id:"button-addon2",onClick:p=>D("completion_criteria",u)}," \u522A\u9664 ",8,Mt)]))),128)),e("button",{type:"button",class:"btn btn-sm btn-outline-primary",onClick:t[8]||(t[8]=s=>M("completion_criteria"))}," \u65B0\u589E\u4E00\u5217 ")])])])])]),Bt,Ft,e("div",jt,[v(e("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":t[9]||(t[9]=s=>V.value=s),id:"task-has-level","true-value":!0,"false-value":!1},null,512),[[R,V.value]]),qt]),V.value?(r(),d("div",At,[(r(!0),d(C,null,$(a.value.level,(s,u)=>(r(),d("div",{class:"input-group mb-3",key:`level_${u}`},[v(e("input",{type:"text",class:"form-control",placeholder:"\u7B49\u7D1A\u5167\u5BB9","aria-label":"\u7B49\u7D1A\u5167\u5BB9","onUpdate:modelValue":p=>s.content=p,"aria-describedby":"button-addon2"},null,8,Nt),[[I,s.content]]),e("button",{class:"btn btn-outline-danger",type:"button",id:"button-addon2",onClick:p=>D("level",u)}," \u522A\u9664 ",8,Et)]))),128)),e("button",{type:"button",class:"btn btn-sm btn-outline-primary",onClick:t[10]||(t[10]=s=>M("level"))}," \u65B0\u589E\u4E00\u5217 ")])):G("",!0),Gt,Rt,e("div",Ot,[v(e("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":t[11]||(t[11]=s=>U.value=s),id:"beforeStart","true-value":!0,"false-value":!1},null,512),[[R,U.value]]),Pt]),U.value?(r(),d("div",zt,[Dt,v(e("select",{class:"form-select",id:"predecessor_task_id","onUpdate:modelValue":t[12]||(t[12]=s=>a.value.predecessor_task_id=s),"aria-label":"Floating label select example"},[(r(!0),d(C,null,$(Y.value,s=>(r(),d("option",{value:s.id,key:s.id},k(s.name),9,Jt))),128))],512),[[we,a.value.predecessor_task_id]])])):G("",!0),Ht,e("div",Qt,[e("div",Kt,[e("div",Wt,[Xt,v(e("input",{type:"date",class:"form-control",id:"task_start_at","onUpdate:modelValue":t[13]||(t[13]=s=>a.value.start_at=s),placeholder:""},null,512),[[I,a.value.start_at]])])]),e("div",Yt,[e("div",Zt,[es,v(e("input",{type:"date",class:"form-control",id:"task_expired_at","onUpdate:modelValue":t[14]||(t[14]=s=>a.value.expired_at=s),placeholder:""},null,512),[[I,a.value.expired_at]])])])]),e("div",ts,[v(e("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":t[15]||(t[15]=s=>a.value.enable=s),id:"enable","true-value":!0,"false-value":!1},null,512),[[R,a.value.enable]]),ss]),e("div",as,[e("div",os,[e("button",{type:"submit",class:"btn btn-lg btn-primary mt-2",disabled:Object.keys(c).length>0},[ns,W(" "+k(m.type==="create"?"\u5EFA\u7ACB\u4EFB\u52D9":"\u5132\u5B58\u66F4\u65B0"),1)],8,ls),Object.keys(c).length>0?(r(),d("p",is," \u8ACB\u78BA\u8A8D\u4EFB\u52D9\u5FC5\u586B\u9805\u76EE\u662F\u5426\u586B\u5BEB\u5B8C\u6574\u3002 ")):G("",!0)])])]),_:1},512)])])}}};export{ps as default};
